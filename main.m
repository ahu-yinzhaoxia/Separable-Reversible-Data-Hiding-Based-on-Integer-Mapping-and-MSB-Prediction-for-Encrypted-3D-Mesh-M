clear; clc; close all;
addpath(genpath(pwd));

fprintf('Conduct RDH-ED in 3D meshes:\n');
tic
m=9;
   
%徐娜
% name = 'beetle.off'; 
% name = 'mushroom.off';
% name = 'mannequin.off';
% name ='happy_vrip.ply';%22222222
% name = 'Ramesses.off';
name = 'elephant-50kv.off'; 
% name = 'cube.off';

% name = 'tre_twist.off';                   
source_dir = 'data/source';
source_dir = [source_dir,'/',name];
%% Read 3d mesh 
[~, file_name, suffix] = fileparts(source_dir);
if(strcmp(suffix,'.obj')==0) %off
    [vertex, face] = read_mesh(source_dir);                                                                                              
           plot_mesh(vertex,face);  
    
    
    vertex = vertex'; face = face';
    
    
else    %obj
    Obj = readObj(source_dir);
    vertex = Obj.v; face = Obj.f.v;%
end
% [~, file_name, suffix] = fileparts(source_dir);%22222222
% fprintf('1');%22222222
% [vertex, face] = read_ply(source_dir);%22222222
% vertex = vertex'; face = face';
%  plot_mesh(vertex,face);                                                                                                                                                                                                        
%   for i=1:4    %放大局部的代码
%     subplot(2,2,i);
%     plot_mesh(vertex, face);
%     shading faceted;
%     zoom(1.8^(i+1));
% end
 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
 
 
vertex0 = vertex;
%% Preprocess
magnify = 10^m;
[vertex, bit_len] = meshPrepro(m, vertex);
fprintf('2');
%% Compute mesh length
[meshlen, ver_bin] = meshLength(vertex, bit_len);
%% 误差处理
Vertemb_Wrong=meshError(m,face,vertex0);%在顶点矩阵不做任何处理的情况下，选取出具有误差的顶点编号
% plot_mesh(vertex,face);
% meshlen
% ver_bin
% Generate a psudorandom stream
k_enc = 12345;
sec_bin = logical(pseudoGenerate(meshlen, k_enc));
fprintf('3');
%% XOR  Encrypt
enc_bin = xor(ver_bin, sec_bin);
%% Generate encrypted mesh
encrypt_name = 'encrypted';
vertex1= meshGenerate(enc_bin, magnify, face, bit_len, file_name, encrypt_name);
plot_mesh(vertex1,face); 
fprintf('4');
%% Message embedding
[vertex2, message_bin] = meshEmbed(m, vertex1, face, file_name,Vertemb_Wrong); 
% plot_mesh(vertex2,face);
fprintf('5');
%% Message extraction & mesh recovery
[ext_m, vertex3] = meshRecovery(m,vertex2, face,file_name,vertex0,Vertemb_Wrong);
% plot_mesh(vertex3,face);%recovery mesh
fprintf('6');
toc

%% Test
[hd] = HausdorffDist(vertex0,vertex3,1,0)
snr = meshSNR(vertex0,vertex3)
[v_n, ~] = size(vertex);
capacity = length(ext_m)/v_n
err_dist = message_bin - ext_m;
err_len = length(find(err_dist(:)~=0));
data_err_percent = err_len/length(ext_m)







